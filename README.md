# SA 串口上位机

基于陶晶驰串口屏的Python移植版本

## 功能特性

### 核心功能
- ✅ **Page 0**: 主菜单界面（带旋转动画）
- ✅ **Page 7**: 双参数控制（频率 + 幅值）
- ✅ **Page 8**: 三参数控制（频率 + 幅值 + 峰值）
- ✅ **Page 9**: 系统建模与识别

### 协议支持
- 二进制小端序编码
- 固定6字节命令格式
- 支持下位机反馈自动更新
- 完整实现所有命令（0x21, 0x22, 0x23, 0x01, 0xF0, 0xF1, 0xF2）

## 安装依赖

```bash
pip install -r requirements.txt
```

## 配置串口

编辑 `config.py`，修改串口配置：

```python
# Linux/Mac
SERIAL_PORT = '/dev/ttyUSB0'

# Windows
SERIAL_PORT = 'COM3'

# 波特率（默认115200）
SERIAL_BAUDRATE = 115200
```

## 运行程序

```bash
cd /Users/kwokyuen/Downloads/SA/SA/HMI
python3 main.py
```

或者在IDE中直接运行 `main.py`

**推荐方式**: 直接在IDE（如VSCode、PyCharm）中打开并运行 `main.py`

## 使用说明

### 1. 串口连接
- 启动程序后会弹出串口连接对话框
- 输入串口号和波特率
- 点击"连接"或"跳过（离线）"

### 2. 页面导航
- **主菜单**: 选择不同功能页面
- **基础任务2**: 双参数控制（频率+幅值）
- **基础任务3、4**: 三参数控制（频率+幅值+峰值）
- **发挥部分**: 系统建模与识别

### 3. 操作流程

#### Page 7/8 - 参数控制
1. 点击"启动"按钮进入运行状态
2. 在输入框中设置频率/幅值/峰值
3. 点击"应用"按钮发送命令
4. 下位机会反馈更新当前值显示
5. 点击"Clear Buff"重置为默认值

#### Page 9 - 系统建模
1. 点击"一键学习"启动频率扫描（200Hz-500kHz）
2. 下位机执行扫描并识别滤波器类型
3. 结果显示在黑色区域
4. 点击"启动探究装置"开始实时FFT分析

## 文件结构

```
HMI/
├── main.py                   # 主程序入口
├── config.py                 # 配置文件
├── serial_comm.py            # 串口通信模块
├── ui_main_menu.py           # 主菜单页面
├── ui_dual_param.py          # 双参数控制页面（频率+幅值）
├── ui_triple_param.py        # 三参数控制页面（频率+幅值+峰值）
├── ui_modeling.py            # 系统建模页面
├── requirements.txt          # 依赖包
└── README.md                 # 本文件
```

## 协议说明

### 命令格式（发送到下位机）

| 命令 | 命令码 | 数据格式 | 总长度 | 示例 |
|------|--------|---------|--------|------|
| 频率设置（方式2） | 0x21 | 4字节小端序 | 6字节 | `21 E8 03 00 00 00` (1000Hz) |
| 频率设置（方式1） | 0xF2 | 4字节小端序 | 6字节 | `F2 E8 03 00 00 00` (1000Hz) |
| 幅值设置 | 0x22 | 3字节×100小端序 | 6字节 | `22 5E 01 00 ...` (3.5V) |
| 峰值设置 | 0x23 | 3字节×100小端序 | 6字节 | `23 F4 01 00 ...` (5.0V) |
| Clear Buff | 0x01 | 固定格式 | 6字节 | `01 01 01 01 01 01` |
| 建模命令 | 0xF0 | 固定格式 | 6字节 | `F0 F0 F0 F0 F0 24` |
| 启动命令 | 0xF1 | 固定格式 | 6字节 | `F1 F1 F1 F1 F1 24` |

### 反馈格式（下位机返回）

```
控件名.属性="值"\xff\xff\xff
```

**示例**:
```
f0.txt="1000 Hz"\xff\xff\xff
v0.txt="3.50 V"\xff\xff\xff
vp0.txt="5.00 V"\xff\xff\xff
result.txt="Filter Type : LPF"\xff\xff\xff
```

## 注意事项

1. **串口权限**: Linux/Mac需要确保用户有串口访问权限
   ```bash
   sudo chmod 666 /dev/ttyUSB0
   # 或添加用户到dialout组
   sudo usermod -a -G dialout $USER
   ```

2. **波特率**: 确保与下位机设置一致（默认115200）

3. **离线模式**: 可跳过串口连接进入离线演示模式

4. **数据格式**: 
   - 频率使用整数（Hz）
   - 电压需要×100后发送
   - 所有命令固定6字节长度

## 调试

程序运行时会在控制台输出调试信息：
- `→` 表示发送命令
- `←` 表示接收反馈
- `✓` 表示成功操作
- `✗` 表示错误

示例输出：
```
✓ 串口连接成功: /dev/ttyUSB0 @ 115200bps
→ 发送频率命令: 1000Hz (模式2), HEX: 21E8030000
← 接收频率反馈: 1000 Hz
```

## 技术栈

- Python 3.7+
- tkinter (GUI)
- pyserial (串口通信)
- struct (二进制编码)
- threading (异步接收)

## 参考文档

- `Apply_HMI_Design_Documentation.md` - 完整设计文档
- `SA.sdk/FFTCTR/src/ISR.c` - 下位机协议实现



